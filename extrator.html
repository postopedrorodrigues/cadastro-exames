<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Extrator de PDF - Pacientes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <a href="index.html">â† Voltar</a>
  <h1>ğŸ“¥ Extrator de PDF - Pacientes</h1>

  <div id="dropZone">ğŸ“‚ Arraste o PDF aqui ou clique para selecionar</div>
  <input type="file" id="pdfInput" accept=".pdf" style="display: none;" />

  <h2>ğŸ” Texto extraÃ­do:</h2>
  <textarea id="pdfText" readonly></textarea>

  <h2>ğŸ“‹ JSON de dados extraÃ­dos:</h2>
  <textarea id="jsonOutput" readonly></textarea>

  <button id="enviarBtn">ğŸš€ Enviar para API</button>

  <h2>ğŸ› ï¸ Log de Debug:</h2>
  <div class="log" id="logOutput">Aguardando arquivo...</div>

  <script>
    const pdfInput = document.getElementById("pdfInput");
    const dropZone = document.getElementById("dropZone");
    const pdfTextArea = document.getElementById("pdfText");
    const jsonOutput = document.getElementById("jsonOutput");
    const log = document.getElementById("logOutput");
    const enviarBtn = document.getElementById("enviarBtn");

    let paciente = null;

    const logMsg = (msg) => {
      log.textContent += "\n" + msg;
    };

    const extract = (text, regex, label = "") => {
      const match = text.match(regex);
      if (match && match[1]) {
        logMsg(`âœ… ${label} encontrado: ${match[1].trim()}`);
        return match[1].trim();
      } else {
        logMsg(`âš ï¸ ${label} nÃ£o encontrado.`);
        return "";
      }
    };

    const processPDF = async (file) => {
      log.textContent = "ğŸ“‚ Lendo PDF...";
      const reader = new FileReader();

      reader.onload = async function () {
        const typedArray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;

        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const pageText = content.items.map(item => item.str).join(" ");
          text += pageText + "\n";
        }

        pdfTextArea.value = text;
        logMsg("ğŸ“„ Texto extraÃ­do com sucesso!");

        const nome_paciente = extract(text, /Paciente:\s*([A-ZÃ€-Ãš\s]+[A-ZÃ€-Ãš])(?=\s+EndereÃ§o)/i, "Nome do Paciente");
        const data_nascimento = extract(text, /Nascimento:\s*(\d{2}\/\d{2}\/\d{4})/, "Data de Nascimento").split("/").reverse().join("-");
        const cartao_sus = extract(text, /CartÃ£o SUS:\s*(\d{15})/, "CartÃ£o SUS");
        const endereco = extract(text, /EndereÃ§o:\s*(.*?)(?=\s*Contato)/, "EndereÃ§o");

        const telefoneMatch = text.match(/Contato\(s\):\s*\(?(\d{2})\)?[-\s]?(\d{4,5}-?\d{4})/);
        let telefone = "";
        if (telefoneMatch) {
          telefone = telefoneMatch[1] + telefoneMatch[2].replace(/[^0-9]/g, "");
          logMsg(`âœ… Telefone encontrado: ${telefone}`);
        } else {
          logMsg("âš ï¸ Telefone nÃ£o encontrado.");
        }

        const protocolo = extract(text, /PROTOCOLO DE ATENDIMENTO\s*NÂº:\s*(\d+)/, "Protocolo");
        const unidade_solicitante = extract(text, /UNIDADE SOLICITANTE:\s*(.+?)\s*PROFISIONAL/, "Unidade Solicitante");
        const profissional_solicitante = extract(text, /PROFISIONAL SOLICITANTE:\s*([A-Z\s]+)/, "Profissional Solicitante");

        const examesEncontrados = [];
        const exameRegex = /(\d{10})\s+([A-ZÃ‡ÃƒÃÃ‰ÃÃ“ÃšÃœ\/0-9\s\-]+?)\s+1/g;
        let match;
        while ((match = exameRegex.exec(text)) !== null) {
          examesEncontrados.push({
            codigo: match[1],
            nome: match[2].trim(),
            quantidade: 1
          });
          logMsg(`ğŸ§ª Exame extraÃ­do: ${match[2].trim()} (${match[1]})`);
        }

        // Verifica se tem data de marcaÃ§Ã£o (formato: dd/mm/yyyy DDD hh:mm)
        let data_agendamento = "";
        let status = "agendado";

        const dataMarcada = text.match(/(\d{2}\/\d{2}\/\d{4})\s+\w{3}\s+\d{2}:\d{2}/);
        if (dataMarcada) {
          data_agendamento = dataMarcada[1].split("/").reverse().join("-");
          status = "marcado";
          logMsg(`ğŸ“… Exame marcado para: ${dataMarcada[1]}`);
        } else {
          logMsg(`ğŸ“… Nenhuma data de marcaÃ§Ã£o encontrada. Status mantido como agendado.`);
        }

        const data_cadastro = new Date().toISOString().split("T")[0];

        paciente = {
          nome_paciente,
          data_nascimento,
          cartao_sus,
          endereco,
          telefone,
          protocolo,
          unidade_solicitante,
          profissional_solicitante,
          exames_solicitados: examesEncontrados,
          status,
          data_agendamento,
          data_cadastro
        };

        jsonOutput.value = JSON.stringify(paciente, null, 2);
        logMsg("âœ… JSON montado com sucesso! Pronto para enviar.");
      };

      reader.readAsArrayBuffer(file);
    };

    enviarBtn.addEventListener("click", async () => {
      if (!paciente) {
        logMsg("âš ï¸ Nenhum JSON montado para enviar.");
        return;
      }

      try {
        const response = await fetch("http://localhost:3000/api/exames", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(paciente)
        });

        if (response.ok) {
          logMsg("ğŸš€ Dados enviados com sucesso para API.");
        } else {
          const erro = await response.json();
          logMsg(`âŒ Erro da API: ${erro.error || "Erro desconhecido"}`);
        }
      } catch (error) {
        logMsg(`âŒ Erro de conexÃ£o com a API: ${error.message}`);
      }
    });

    dropZone.addEventListener("click", () => pdfInput.click());
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("hover");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("hover");
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("hover");
      const file = e.dataTransfer.files[0];
      if (file && file.type === "application/pdf") {
        processPDF(file);
      } else {
        logMsg("âŒ Arquivo invÃ¡lido. Envie um PDF.");
      }
    });

    pdfInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) {
        processPDF(file);
      }
    });
  </script>
</body>
</html>
